---
title: "Activity 2 Filled"
author: "Brooke Wolford"
date: "2025-12-08"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Activity 2

Objective: Use information from Module 2 to visualize data with ggplot2

Please use the pair programming approach again.tor roles roughly every 10 minutes or whenever you come to a natural break point.

### Set up environment


```{r}

library(haven)
library(tidyr)
library(dplyr)
library(readr)
library(ggplot2)
library(skimr)

sessionInfo()

```

### Reading in the data

As in Activity 1, we are reading in data from the National Health and Nutrition Examination Survey from August 2021-August 2023. The complete set of data is available [here](https://wwwn.cdc.gov/nchs/nhanes/search/datapage.aspx?Component=Questionnaire&Cycle=2021-2023).

If you remember, we used the join function to join diabetes, weight, and physical activity data frames into one data frame. We tidied it up and wrote it out a file called NHANES.csv. Let's read that file in.

As before, we need to set the working directory to the github repository. In the Files tab in the lower right panel, navigate to the "from-tidy-data-to-tidy-models-modeling-sensitive-health-data-in-r" directory. Select the arrow beside of "More" and "Copy Folder Path to Clipboard." Paste that below within quotes as an argument for the `setwd()` function as illustrated below.

```{r}

#set working directory
#setwd("OBiWoW-2025/12-Friday/from-tidy-data-to-tidy-models-modeling-sensitive-health-data-in-r/")

#diabetes
df<-read_csv("data/NHANES.csv")

```

### Plotting

Let's start by creating a violin plot that shows the distribution of BMI by Diabetes status.

```{r}

#use geom_violin() with Diabetes on the x-axis and BMI on the y-axis
df %>% ggplot(aes(x=Diabetes,y=BMI)) + geom_violin()

#that didn't look as we expected, why not? 
#HINT use glimpse() to check the column classes
glimpse(df)

#Diabetes is being considered as a double or numeric class instead of a factor so the x-axis is continuous rather than categorical
#Let's change the class

df <- df %>% mutate(Diabetes=as.factor(Diabetes))

#now let's try the plot again
df %>% ggplot(aes(x=Diabetes,y=BMI)) + geom_violin()

```

Look at your plot. What values are now on the x-axis? Check the documentation to remind yourself what these mean.

The documentation for the files can be found here:
[diabetes](https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2021/DataFiles/DIQ_L.htm)
[physical activity](https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2021/DataFiles/PAQ_L.htm)
[weight](https://wwwn.cdc.gov/Nchs/Data/Nhanes/Public/2021/DataFiles/WHQ_L.htm)

The y-axis is way larger than we would expect for BMI. What is going on? Use the `skim()` function to look at the distribution of BMI (p0,p25,p50,p75, and p100 are the percentiles). 

```{r}

#use skim to look at the distribution of BMI
df %>% filter(BMI>200) %>% count()

```


If you recall, we created the BMI variable. It's likely that some of the height and weight measurements were incorrect, leading us to have outliers in BMI. A common rule of thumb for excluding outliers is removing variables that have a value outside the range of 1.5 times the interquartile range. Let's follow that rule.

```{r}

#save a new data frame that has BMI outliers excluded
df2<-df %>% mutate(
  q1=quantile(BMI,0.25),
  q3=quantile(BMI,0.75),
  iqr=q3-q1
) %>% filter(BMI>q1-1.5*iqr & BMI<q3+1.5*iqr) %>% select(-c(q1,q3,iqr))

#use nrow() to figure out how many samples we lost
nrow(df)
nrow(df2)

#what is the distribution of BMI now?
skim(df2)

#now let's try the plot again
df2 %>% ggplot(aes(x=Diabetes,y=BMI)) + geom_violin()

#try adding a boxplot with a narrow width so it fits inside the violin plot
df2 %>% ggplot(aes(x=Diabetes,y=BMI)) + geom_violin() + geom_boxplot(width=0.15)

#let's make every diabetes status a different color to fill the violin plots
df2 %>% ggplot(aes(x=Diabetes,y=BMI,fill=Diabetes)) + geom_violin() + geom_boxplot(width=0.15)

#let's add our own colors
df2 %>% ggplot(aes(x=Diabetes,y=BMI,fill=Diabetes)) + geom_violin() + geom_boxplot(width=0.15) + scale_fill_manual(values=c("goldenrod3","orchid4","lightblue","darkgreen"))

#let's remove the legend since we will label the x-axis
df2 %>% ggplot(aes(x=Diabetes,y=BMI,fill=Diabetes)) + geom_violin() + geom_boxplot(width=0.15) + scale_fill_manual(values=c("goldenrod3","orchid4","lightblue","darkgreen"))

#let's rename the labels
df2 %>% ggplot(aes(x=Diabetes,y=BMI,fill=Diabetes)) + geom_violin() + geom_boxplot(width=0.15) + scale_fill_manual(values=c("goldenrod3","orchid4","lightblue","darkgreen")) 
  scale_x_discrete(labels=c("1"="Diabetes","2"="No Diabetes","3"="Borderline Diabetes","9"="Unsure"))

#let's use remove the legend since we have labels on the x axis
df2 %>% ggplot(aes(x=Diabetes,y=BMI,fill=Diabetes)) + geom_violin() + geom_boxplot(width=0.15) + scale_fill_manual(values=c("goldenrod3","orchid4","lightblue","darkgreen")) + 
   scale_x_discrete(labels=c("1"="Diabetes","2"="No Diabetes","3"="Borderline Diabetes","9"="Unsure")) +   theme(legend.position="none") 

#let's use a pre-defined theme to make a white background
df2 %>% ggplot(aes(x=Diabetes,y=BMI,fill=Diabetes)) + geom_violin() + geom_boxplot(width=0.15) + scale_fill_manual(values=c("goldenrod3","orchid4","lightblue","darkgreen")) + 
   scale_x_discrete(labels=c("1"="Diabetes","2"="No Diabetes","3"="Borderline Diabetes","9"="Unsure")) +   theme_bw() + theme(legend.position="none")

#let's add a title
df2 %>% ggplot(aes(x=Diabetes,y=BMI,fill=Diabetes)) + geom_violin() + geom_boxplot(width=0.15) + scale_fill_manual(values=c("goldenrod3","orchid4","lightblue","darkgreen")) + 
   scale_x_discrete(labels=c("1"="Diabetes","2"="No Diabetes","3"="Borderline Diabetes","9"="Unsure")) +   theme_bw() + theme(legend.position="none") + labs(title="BMI by Diabetes status in NHANES")


```


  

